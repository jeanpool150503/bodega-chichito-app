<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bodega Pool - Acceso Cámara</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --bg-app: #f8fafc;
            --surface: #ffffff;
            --text-title: #0f172a;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; background-color: var(--bg-app); 
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* Pantalla de Inicio / Permisos */
        #permission-screen {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; text-align: center;
        }

        .btn-principal {
            background: var(--primary); color: white; border: none;
            padding: 16px 32px; border-radius: 12px; font-size: 1rem;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }

        /* Pantalla de Cámara */
        #camera-screen { display: none; position: relative; flex: 1; background: #000; }

        video { width: 100%; height: 100%; object-fit: cover; }

        .controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: center; align-items: center; gap: 20px;
        }

        .shutter {
            width: 70px; height: 70px; border-radius: 50%; background: white;
            border: 5px solid rgba(255,255,255,0.3); cursor: pointer;
        }

        .error-msg { color: #ef4444; margin-top: 15px; font-size: 0.9rem; display: none; }
    </style>
</head>
<body>

    <div id="permission-screen">
        <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);">
            <i data-lucide="camera" size="48" color="#4f46e5" style="margin-bottom: 15px;"></i>
            <h2 style="margin: 0 0 10px 0;">Acceso a Cámara</h2>
            <p style="color: #64748b; margin-bottom: 25px;">Para capturar el entorno de la bodega, necesitamos permiso para usar la cámara trasera.</p>
            
            <button class="btn-principal" onclick="requestCameraPermission()">
                <i data-lucide="shield-check"></i>
                Abrir Cámara
            </button>
            
            <div id="error-text" class="error-msg">
                Permiso denegado. Por favor, actívalo en los ajustes de tu navegador Android.
            </div>
        </div>
    </div>

    <div id="camera-screen">
        <video id="webcam" autoplay playsinline></video>
        <div class="controls">
            <button class="shutter" onclick="capture()"></button>
        </div>
    </div>

    <script>
        async function requestCameraPermission() {
            const errorText = document.getElementById('error-text');
            
            try {
                // Esto lanza el cuadro de diálogo nativo de Android (Aceptar/Rechazar)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { exact: "environment" } // Obliga a usar la cámara trasera
                    }
                });

                // Si llega aquí, el usuario hizo clic en "Permitir"
                showCamera(stream);
                
            } catch (err) {
                console.error("Error de permisos: ", err);
                
                // Si falla la cámara trasera específica, intentamos la cámara por defecto
                try {
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    showCamera(fallbackStream);
                } catch (secondErr) {
                    // Si llega aquí, el usuario hizo clic en "Bloquear" o "Rechazar"
                    errorText.style.display = 'block';
                }
            }
        }

        function showCamera(stream) {
            document.getElementById('permission-screen').style.display = 'none';
            const cameraScreen = document.getElementById('camera-screen');
            const video = document.getElementById('webcam');
            
            cameraScreen.style.display = 'block';
            video.srcObject = stream;
        }

        function capture() {
            alert("¡Foto capturada!");
            // Aquí podrías añadir la lógica para guardar la imagen
        }

        // Inicializar iconos
        lucide.createIcons();
    </script>
</body>
</html>
