<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bodega Chichito - Sistema Equipo</title>
    <style>
        body { margin: 0; padding: 0; background: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Barra de progreso superior */
        #update-progress-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 5px;
            background: rgba(79, 70, 229, 0.1); z-index: 10001; display: none;
        }
        #update-bar {
            width: 0%; height: 100%; 
            background: linear-gradient(90deg, #4f46e5, #818cf8);
            transition: width 0.3s ease; 
            box-shadow: 0 0 8px rgba(79, 70, 229, 0.4);
        }

        /* Mensaje flotante */
        #update-status {
            position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white;
            padding: 6px 16px; border-radius: 30px; font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none;
            z-index: 10000; font-weight: 600; letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

    <div id="update-progress-container"><div id="update-bar"></div></div>
    <div id="update-status">Actualizando aplicaci√≥n...</div>
    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDubf98-7P2UI8XY-kJyt4GFIb9HT0Bh6g",
            authDomain: "caneteservicios.firebaseapp.com",
            projectId: "caneteservicios",
            storageBucket: "caneteservicios.firebasestorage.app",
            messagingSenderId: "1074586569660",
            appId: "1:1074586569660:web:00f2252b017071609379b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appRef = doc(db, "configuracion", "app");

        function ejecutarApp(codigo) {
            if (!codigo) return;
            document.open();
            document.write(codigo);
            document.close();
        }

        // Carga inmediata si existe en memoria
        const savedCode = localStorage.getItem('local_app_code');
        if (savedCode) ejecutarApp(savedCode);

        // Escucha de actualizaciones
        onSnapshot(appRef, (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                const cloudCode = data.codigo_fuente;
                const cloudVersion = data.version;
                const localVersion = localStorage.getItem('local_app_version');

                if (cloudVersion !== localVersion) {
                    // Activar visuales de carga
                    document.getElementById('update-progress-container').style.display = 'block';
                    document.getElementById('update-status').style.display = 'block';
                    
                    let progress = 0;
                    const bar = document.getElementById('update-bar');
                    
                    const interval = setInterval(() => {
                        progress += 2; // Carga suave
                        if(progress <= 98) bar.style.width = progress + '%';
                        
                        if (progress >= 100) {
                            clearInterval(interval);
                            bar.style.width = '100%';
                            
                            localStorage.setItem('local_app_code', cloudCode);
                            localStorage.setItem('local_app_version', cloudVersion);
                            
                            setTimeout(() => {
                                location.reload();
                            }, 400);
                        }
                    }, 40); 
                }
            }
        });
    </script>
</body>
</html>
