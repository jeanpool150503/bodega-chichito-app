<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bodega Chichito - Sistema Equipo</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilo de carga inicial */
        body { 
            margin: 0; padding: 0; background: #f8fafc; 
            font-family: sans-serif; display: flex; 
            align-items: center; justify-content: center; height: 100vh; 
        }
        .loader-container { text-align: center; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top: 4px solid #4f46e5; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .msg { color: #64748b; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="boot-screen" class="loader-container">
        <div class="spinner"></div>
        <div class="msg">Sincronizando sistema...</div>
    </div>

    <div id="app-root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDubf98-7P2UI8XY-kJyt4GFIb9HT0Bh6g",
            authDomain: "caneteservicios.firebaseapp.com",
            projectId: "caneteservicios",
            storageBucket: "caneteservicios.firebasestorage.app",
            messagingSenderId: "1074586569660",
            appId: "1:1074586569660:web:00f2252b017071609379b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Referencia a la configuración de la app en la nube
        const appRef = doc(db, "configuracion", "app");

        // ESCUCHA EN TIEMPO REAL
        onSnapshot(appRef, (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                const cloudCode = data.codigo_fuente;
                const cloudVersion = data.version;

                // Guardar en memoria local por si se quedan sin internet
                localStorage.setItem('local_app_code', cloudCode);
                localStorage.setItem('local_app_version', cloudVersion);

                ejecutarApp(cloudCode);
            } else {
                document.querySelector('.msg').innerText = "Error: Sistema no configurado en Admin.";
            }
        });

        function ejecutarApp(codigo) {
            if (!codigo) return;
            
            // Reemplazamos el contenido de la página con el código de la nube
            // Usamos document.open/write para reconstruir el HTML completamente
            document.open();
            document.write(codigo);
            document.close();
        }

        // Si no hay internet al iniciar, cargar la última versión guardada
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!window.navigator.onLine) {
                    const savedCode = localStorage.getItem('local_app_code');
                    if (savedCode) {
                        ejecutarApp(savedCode);
                    } else {
                        document.querySelector('.msg').innerText = "Sin conexión y sin datos previos.";
                    }
                }
            }, 3000);
        });
    </script>
</body>
</html>
